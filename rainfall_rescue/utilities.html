<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Utility functions for Rainfall Rescue data &#8212; Robot Rainfall Rescue</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxdoc.css?v=34905f61" />
    <script src="../_static/documentation_options.js?v=d45e8c67"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Image processing functions for the Rainfall Rescue images" href="../RR_utils/image.html" />
    <link rel="prev" title="Diagnostic plots for Rainfall Rescue data" href="diagnostics.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../RR_utils/image.html" title="Image processing functions for the Rainfall Rescue images"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="diagnostics.html" title="Diagnostic plots for Rainfall Rescue data"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">RRR</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Utility functions for Rainfall Rescue data</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="utility-functions-for-rainfall-rescue-data">
<h1>Utility functions for Rainfall Rescue data<a class="headerlink" href="#utility-functions-for-rainfall-rescue-data" title="Link to this heading">Â¶</a></h1>
<p>This is a pair of library utility files with miscelanious useful functions:</p>
<ul class="simple">
<li><p><cite>pairs.py</cite> - functions to read and write pairs of images and CSV files containing the original Rainfall Rescue transcriptions.</p></li>
<li><p><cite>validate.py</cite> - plotting functions used in comparison plots showing the skill of AI transcriptions</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Utility functions for handling RR image/CSV pairs</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">csv</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>


<span class="c1"># Get the image/csv names</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_index_list</span><span class="p">(</span><span class="n">max_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fake</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fake</span><span class="p">:</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PDIR&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">/fake_training_data/images&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.jpg&quot;</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PDIR&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">/from_Ed/images&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.jpg&quot;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">training</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">training</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">result</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;0&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">result</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">max_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_n</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[:</span><span class="n">max_n</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="c1"># Load a csv file into a data structure (dictionary)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_station_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reader</span><span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;null&quot;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;Number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;Years&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">:</span>  <span class="c1"># Monthly data</span>
                <span class="n">result</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">17</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;Totals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="c1"># Convert the csv data to a json string</span>
<span class="c1"># To serve as target for the model</span>
<span class="k">def</span><span class="w"> </span><span class="nf">csv_to_json</span><span class="p">(</span><span class="n">csv_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert CSV data to a JSON string.</span>

<span class="sd">    Args:</span>
<span class="sd">        csv_data (dict): The CSV data as a dictionary.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: JSON string representation of the CSV data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">csv_data</span><span class="p">[</span><span class="s2">&quot;Number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">csv_data</span><span class="p">[</span><span class="s2">&quot;Number&quot;</span><span class="p">])</span>  <span class="c1"># Easier if this is a string</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">csv_data</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">))</span>
    <span class="c1"># reformat to match LLM schema</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;\[([^\]]*)\]&quot;</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span>
        <span class="n">j</span><span class="p">,</span>
        <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="s2">&quot;{</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">}&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">j</span>


<span class="c1"># Load a pair of image and csv data</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_pair</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a pair of image and CSV file based on the label.</span>

<span class="sd">    Args:</span>
<span class="sd">        label (str): The label of the image and CSV file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple containing the image and the CSV file path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># Real data</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PDIR&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">/from_Ed/images&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">.jpg&quot;</span><span class="p">)</span>
        <span class="n">csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PDIR&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">/from_Ed/csvs&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">image_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image </span><span class="si">{</span><span class="n">image_path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">csv_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CSV </span><span class="si">{</span><span class="n">csv_path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
        <span class="n">csv</span> <span class="o">=</span> <span class="n">load_station_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fake data</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PDIR&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">/fake_training_data/images&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">.jpg&quot;</span>
        <span class="p">)</span>
        <span class="n">csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PDIR&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">/fake_training_data/csvs&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">image_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image </span><span class="si">{</span><span class="n">image_path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">csv_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CSV </span><span class="si">{</span><span class="n">csv_path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
        <span class="n">csv</span> <span class="o">=</span> <span class="n">load_fake_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">csv</span>


<span class="c1"># Load a pair of image and csv data - from the fake training data</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_fake_pair</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
    <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PDIR&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">/fake_training_data/images&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">.jpg&quot;</span>
    <span class="p">)</span>
    <span class="n">csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PDIR&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">/fake_training_data/csvs&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">image_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image </span><span class="si">{</span><span class="n">image_path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">csv_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CSV </span><span class="si">{</span><span class="n">csv_path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
    <span class="n">csv</span> <span class="o">=</span> <span class="n">load_fake_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">csv</span>


<span class="c1"># Load a csv file into a data structure (dictionary)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_fake_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>  <span class="c1"># Json needs double quotes</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Functions to make validation plots for rainfall_rescue</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">rainfall_rescue.utils.pairs</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_pair</span><span class="p">,</span> <span class="n">csv_to_json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.text</span><span class="w"> </span><span class="kn">import</span> <span class="n">TextPath</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">PathPatch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.transforms</span><span class="w"> </span><span class="kn">import</span> <span class="n">Affine2D</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_two_colored_text</span><span class="p">(</span>
    <span class="n">ax</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">text1</span><span class="p">,</span> <span class="n">text2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">colour1</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">colour2</span><span class="o">=</span><span class="s2">&quot;red&quot;</span>
<span class="p">):</span>

    <span class="c1"># Calculate scaling factors from points to axes coordinates</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>
    <span class="n">axes_bbox</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_window_extent</span><span class="p">()</span><span class="o">.</span><span class="n">transformed</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">dpi_scale_trans</span><span class="o">.</span><span class="n">inverted</span><span class="p">())</span>
    <span class="n">axes_width_inch</span> <span class="o">=</span> <span class="n">axes_bbox</span><span class="o">.</span><span class="n">width</span>
    <span class="n">axes_height_inch</span> <span class="o">=</span> <span class="n">axes_bbox</span><span class="o">.</span><span class="n">height</span>
    <span class="n">scale_x</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">axes_width_inch</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">72</span><span class="p">)</span>
    <span class="n">scale_y</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">axes_height_inch</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">72</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">TextPath</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">text1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="n">Affine2D</span><span class="p">()</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">scale_x</span><span class="p">,</span> <span class="n">scale_y</span><span class="p">)</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span>
    <span class="n">patch</span> <span class="o">=</span> <span class="n">PathPatch</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colour1</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
    <span class="n">verts</span> <span class="o">=</span> <span class="n">patch</span><span class="o">.</span><span class="n">get_path</span><span class="p">()</span><span class="o">.</span><span class="n">vertices</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="n">patch</span><span class="o">.</span><span class="n">get_transform</span><span class="p">()</span>
    <span class="n">verts_data</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">verts</span><span class="p">)</span>
    <span class="n">verts_axes</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">verts_data</span><span class="p">)</span>
    <span class="n">right_limit_text1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">verts_axes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">TextPath</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">text2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Affine2D</span><span class="p">()</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">scale_x</span><span class="p">,</span> <span class="n">scale_y</span><span class="p">)</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">right_limit_text1</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span>
    <span class="p">)</span>
    <span class="n">patch</span> <span class="o">=</span> <span class="n">PathPatch</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colour2</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>


<span class="c1"># Present extracted data as a %.2f string as far as possible</span>
<span class="k">def</span><span class="w"> </span><span class="nf">format_value</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">year_idx</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;Name&quot;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;Number&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;N/A&quot;</span>
    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;Years&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">year_idx</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;N/A&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">year_idx</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;N/A&quot;</span>

    <span class="k">return</span> <span class="n">format_as_2f</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">format_as_2f</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format a value as a string with two decimal places.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;null&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;null&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># Return as is if it cannot be converted to float</span>


<span class="c1"># Plot the image into a given axes</span>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_image</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
    <span class="n">imgplot</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>


<span class="c1"># Plot target and retrieved image metadata into a given axes</span>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_metadata</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">extracted</span><span class="p">,</span> <span class="n">jcsv</span><span class="p">):</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

    <span class="n">ymp</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="k">for</span> <span class="n">metad</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Number&quot;</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">):</span>
        <span class="n">exv</span> <span class="o">=</span> <span class="n">extracted</span><span class="p">[</span><span class="n">metad</span><span class="p">]</span>
        <span class="n">rrv</span> <span class="o">=</span> <span class="n">jcsv</span><span class="p">[</span><span class="n">metad</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">exv</span> <span class="o">==</span> <span class="n">rrv</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="mf">0.05</span><span class="p">,</span>
                <span class="n">ymp</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metad</span><span class="p">,</span> <span class="n">exv</span><span class="p">),</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="mf">0.05</span><span class="p">,</span>
                <span class="n">ymp</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metad</span><span class="p">,</span> <span class="n">exv</span><span class="p">),</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="mf">0.05</span><span class="p">,</span>
                <span class="n">ymp</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metad</span><span class="p">,</span> <span class="n">rrv</span><span class="p">),</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">ymp</span> <span class="o">-=</span> <span class="mf">0.3</span>


<span class="k">def</span><span class="w"> </span><span class="nf">models_agree</span><span class="p">(</span><span class="n">extracted</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">agreement_count</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the models agree on a value.&quot;&quot;&quot;</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">extracted</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;Years&quot;</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">extracted</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="n">value</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">format_as_2f</span><span class="p">(</span><span class="n">extracted</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="n">value</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">extracted</span><span class="p">[</span><span class="n">model_id</span><span class="p">][</span><span class="n">value</span><span class="p">]</span>
        <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">top_two</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">top_two</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;N/A&quot;</span><span class="p">:</span>  <span class="c1"># Special case - &#39;agreed&#39; on &quot;can&#39;t do it&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>  <span class="c1"># Not counted as agreement</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_two</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">top_two</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># Only one unique value</span>
    <span class="k">if</span> <span class="n">top_two</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">top_two</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># No one most common value</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">top_two</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">top_two</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">agreement_count</span><span class="p">:</span>  <span class="c1"># Most common value is popular enough</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">top_two</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">top_two</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_metadata_agreement</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">extracted</span><span class="p">,</span> <span class="n">jcsv</span><span class="p">,</span> <span class="n">agreement_count</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

    <span class="n">ymp</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="k">for</span> <span class="n">metad</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Number&quot;</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">):</span>
        <span class="n">match</span><span class="p">,</span> <span class="n">exv</span> <span class="o">=</span> <span class="n">models_agree</span><span class="p">(</span><span class="n">extracted</span><span class="p">,</span> <span class="n">metad</span><span class="p">,</span> <span class="n">agreement_count</span><span class="o">=</span><span class="n">agreement_count</span><span class="p">)</span>
        <span class="n">rrv</span> <span class="o">=</span> <span class="n">jcsv</span><span class="p">[</span><span class="n">metad</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>  <span class="c1"># Models agree</span>
            <span class="k">if</span> <span class="n">exv</span> <span class="o">==</span> <span class="n">rrv</span><span class="p">:</span>  <span class="c1"># on the right answer</span>
                <span class="n">colour</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Blue</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># on the wrong answer</span>
                <span class="n">colour</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Red</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Models disagree</span>
            <span class="n">colour</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># Grey</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="mf">0.05</span><span class="p">,</span>
            <span class="n">ymp</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metad</span><span class="p">,</span> <span class="n">exv</span><span class="p">),</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">colour</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ymp</span> <span class="o">-=</span> <span class="mf">0.3</span>


<span class="c1"># Plot fractional success at metadata into a given axes</span>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_metadata_fraction_agreement</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">merged</span><span class="p">,</span> <span class="n">cmp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

    <span class="n">ymp</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="k">for</span> <span class="n">metad</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Number&quot;</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">):</span>
        <span class="n">blue</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">metad</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="n">metad</span><span class="p">])</span>
        <span class="n">plot_two_colored_text</span><span class="p">(</span>
            <span class="n">ax</span><span class="p">,</span>
            <span class="mf">0.05</span><span class="p">,</span>
            <span class="n">ymp</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: &quot;</span> <span class="o">%</span> <span class="n">metad</span><span class="p">,</span>
            <span class="s2">&quot;  </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">((</span><span class="n">blue</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span>
            <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="n">colour1</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">colour2</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">red</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">metad</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="n">metad</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">red</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">plot_two_colored_text</span><span class="p">(</span>
                <span class="n">ax</span><span class="p">,</span>
                <span class="mf">0.05</span><span class="p">,</span>
                <span class="n">ymp</span> <span class="o">-</span> <span class="mf">0.15</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: &quot;</span> <span class="o">%</span> <span class="n">metad</span><span class="p">,</span>
                <span class="s2">&quot;  </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">((</span><span class="n">red</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span>
                <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">colour1</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>  <span class="c1"># Invisible</span>
                <span class="n">colour2</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">ymp</span> <span class="o">-=</span> <span class="mf">0.3</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_metadata_fraction</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">merged</span><span class="p">,</span> <span class="n">cmp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

    <span class="n">ymp</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="k">for</span> <span class="n">metad</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Number&quot;</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">):</span>
        <span class="n">fraction</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="n">metad</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="n">metad</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="mf">0.05</span><span class="p">,</span>
            <span class="n">ymp</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metad</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">fraction</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)),</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">cmp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cmp_fraction</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">cmp</span><span class="p">[</span><span class="n">metad</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmp</span><span class="p">[</span><span class="n">metad</span><span class="p">])</span>
            <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span> <span class="k">if</span> <span class="n">cmp_fraction</span> <span class="o">&lt;</span> <span class="n">fraction</span> <span class="k">else</span> <span class="s2">&quot;red&quot;</span>
            <span class="n">plot_two_colored_text</span><span class="p">(</span>
                <span class="n">ax</span><span class="p">,</span>
                <span class="mf">0.05</span><span class="p">,</span>
                <span class="n">ymp</span> <span class="o">-</span> <span class="mf">0.15</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: &quot;</span> <span class="o">%</span> <span class="n">metad</span><span class="p">,</span>
                <span class="s2">&quot;  </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">fraction</span> <span class="o">-</span> <span class="n">cmp_fraction</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)),</span>
                <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">colour1</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>  <span class="c1"># Invisible</span>
                <span class="n">colour2</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">ymp</span> <span class="o">-=</span> <span class="mf">0.3</span>


<span class="c1"># Plot the digitised numbers into a given axes</span>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_monthly_table</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">extracted</span><span class="p">,</span> <span class="n">jcsv</span><span class="p">,</span> <span class="n">yticks</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">10.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">extracted</span><span class="p">[</span><span class="s2">&quot;Years&quot;</span><span class="p">])</span>
    <span class="c1"># Note - this has to be the last change made to the xtics, or the colours will be reset</span>
    <span class="k">for</span> <span class="n">year_idx</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">extracted</span><span class="p">[</span><span class="s2">&quot;Years&quot;</span><span class="p">][</span><span class="n">year_idx</span><span class="p">]</span> <span class="o">!=</span> <span class="n">jcsv</span><span class="p">[</span><span class="s2">&quot;Years&quot;</span><span class="p">][</span><span class="n">year_idx</span><span class="p">]:</span>
            <span class="n">label</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">yticks</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="s2">&quot;Jan&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Feb&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Mar&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Apr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;May&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Jun&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Jul&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Aug&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Sep&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Oct&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Nov&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Dec&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>

    <span class="n">monthNumbers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;January&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;February&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;March&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;April&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
        <span class="s2">&quot;May&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s2">&quot;June&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
        <span class="s2">&quot;July&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
        <span class="s2">&quot;August&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
        <span class="s2">&quot;September&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
        <span class="s2">&quot;October&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s2">&quot;November&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
        <span class="s2">&quot;December&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">year_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">monthNumbers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">exv</span> <span class="o">=</span> <span class="n">format_value</span><span class="p">(</span><span class="n">extracted</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">year_idx</span><span class="p">)</span>
                <span class="n">rrv</span> <span class="o">=</span> <span class="n">format_value</span><span class="p">(</span><span class="n">jcsv</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">year_idx</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">exv</span> <span class="o">==</span> <span class="n">rrv</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                            <span class="n">year_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">monthNumbers</span><span class="p">[</span><span class="n">month</span><span class="p">],</span>
                            <span class="n">exv</span><span class="p">,</span>
                            <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                            <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                            <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                            <span class="n">year_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">monthNumbers</span><span class="p">[</span><span class="n">month</span><span class="p">],</span>
                            <span class="n">exv</span><span class="p">,</span>
                            <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                            <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                            <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                            <span class="n">year_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">monthNumbers</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span>
                            <span class="n">rrv</span><span class="p">,</span>
                            <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                            <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                            <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">rrv</span><span class="p">,</span> <span class="n">exv</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">continue</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_monthly_table_agreement</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">extracted</span><span class="p">,</span> <span class="n">jcsv</span><span class="p">,</span> <span class="n">agreement_count</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">yticks</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">10.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
    <span class="n">xtl</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;N/A&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span>
    <span class="k">for</span> <span class="n">year_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">match</span><span class="p">,</span> <span class="n">xtl</span><span class="p">[</span><span class="n">year_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">models_agree</span><span class="p">(</span>
            <span class="n">extracted</span><span class="p">,</span> <span class="s2">&quot;Years&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">year_idx</span><span class="p">,</span> <span class="n">agreement_count</span><span class="o">=</span><span class="n">agreement_count</span>
        <span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xtl</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">year_idx</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="n">match</span><span class="p">,</span> <span class="n">exv</span> <span class="o">=</span> <span class="n">models_agree</span><span class="p">(</span>
            <span class="n">extracted</span><span class="p">,</span> <span class="s2">&quot;Years&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">year_idx</span><span class="p">,</span> <span class="n">agreement_count</span><span class="o">=</span><span class="n">agreement_count</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>  <span class="c1"># Models agree</span>
            <span class="k">if</span> <span class="n">exv</span> <span class="o">==</span> <span class="n">jcsv</span><span class="p">[</span><span class="s2">&quot;Years&quot;</span><span class="p">][</span><span class="n">year_idx</span><span class="p">]:</span>
                <span class="n">label</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># on the wrong answer</span>
                <span class="n">label</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Models disagree</span>
            <span class="n">label</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s2">&quot;grey&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">yticks</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="s2">&quot;Jan&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Feb&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Mar&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Apr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;May&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Jun&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Jul&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Aug&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Sep&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Oct&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Nov&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Dec&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>

    <span class="n">monthNumbers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;January&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;February&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;March&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;April&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
        <span class="s2">&quot;May&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s2">&quot;June&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
        <span class="s2">&quot;July&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
        <span class="s2">&quot;August&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
        <span class="s2">&quot;September&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
        <span class="s2">&quot;October&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s2">&quot;November&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
        <span class="s2">&quot;December&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">year_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">monthNumbers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">match</span><span class="p">,</span> <span class="n">exv</span> <span class="o">=</span> <span class="n">models_agree</span><span class="p">(</span>
                    <span class="n">extracted</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">year_idx</span><span class="p">,</span> <span class="n">agreement_count</span><span class="o">=</span><span class="n">agreement_count</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>  <span class="c1"># Models agree</span>
                    <span class="k">if</span> <span class="n">exv</span> <span class="o">==</span> <span class="n">jcsv</span><span class="p">[</span><span class="n">month</span><span class="p">][</span><span class="n">year_idx</span><span class="p">]:</span>  <span class="c1"># on the right answer</span>
                        <span class="n">colour</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Blue</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># on the wrong answer</span>
                        <span class="n">colour</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Red</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># Models disagree</span>
                    <span class="n">colour</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="n">year_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">monthNumbers</span><span class="p">[</span><span class="n">month</span><span class="p">],</span>
                    <span class="n">exv</span><span class="p">,</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">colour</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">continue</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_monthly_table_fraction_agreement</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">merged</span><span class="p">,</span> <span class="n">cmp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yticks</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">years</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">years</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">years</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">years</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">years</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">xtfraction</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;Years&quot;</span><span class="p">][</span><span class="n">year_idx</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="s2">&quot;Years&quot;</span><span class="p">][</span><span class="n">year_idx</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">year_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">xtl</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">fraction</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">fraction</span> <span class="ow">in</span> <span class="n">xtfraction</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xtl</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">yticks</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="s2">&quot;Jan&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Feb&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Mar&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Apr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;May&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Jun&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Jul&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Aug&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Sep&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Oct&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Nov&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Dec&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>

    <span class="n">monthNumbers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;January&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;February&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;March&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;April&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
        <span class="s2">&quot;May&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s2">&quot;June&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
        <span class="s2">&quot;July&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
        <span class="s2">&quot;August&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
        <span class="s2">&quot;September&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
        <span class="s2">&quot;October&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s2">&quot;November&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
        <span class="s2">&quot;December&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">monthNumbers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">blue</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">month</span><span class="p">][</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="n">month</span><span class="p">][</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">year</span><span class="p">,</span>
                <span class="n">monthNumbers</span><span class="p">[</span><span class="n">month</span><span class="p">],</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">blue</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">red</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">month</span><span class="p">][</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="n">month</span><span class="p">][</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">red</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="n">year</span><span class="p">,</span>
                    <span class="n">monthNumbers</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">red</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
                <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_monthly_table_fraction</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">merged</span><span class="p">,</span> <span class="n">cmp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yticks</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">years</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">years</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">years</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">years</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">years</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">xtfraction</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">sum</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="s2">&quot;Years&quot;</span><span class="p">][</span><span class="n">year_idx</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="s2">&quot;Years&quot;</span><span class="p">][</span><span class="n">year_idx</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">year_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">xtl</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">fraction</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">fraction</span> <span class="ow">in</span> <span class="n">xtfraction</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xtl</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">yticks</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="s2">&quot;Jan&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Feb&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Mar&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Apr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;May&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Jun&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Jul&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Aug&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Sep&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Oct&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Nov&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Dec&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span>

    <span class="n">monthNumbers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;January&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;February&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;March&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;April&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
        <span class="s2">&quot;May&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="s2">&quot;June&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
        <span class="s2">&quot;July&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
        <span class="s2">&quot;August&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
        <span class="s2">&quot;September&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
        <span class="s2">&quot;October&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s2">&quot;November&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
        <span class="s2">&quot;December&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">monthNumbers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">fraction</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="n">month</span><span class="p">][</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="n">month</span><span class="p">][</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">year</span><span class="p">,</span>
                <span class="n">monthNumbers</span><span class="p">[</span><span class="n">month</span><span class="p">],</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">fraction</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">cmp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cmp_fraction</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">cmp</span><span class="p">[</span><span class="n">month</span><span class="p">][</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmp</span><span class="p">[</span><span class="n">month</span><span class="p">][</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span> <span class="k">if</span> <span class="n">cmp_fraction</span> <span class="o">&lt;</span> <span class="n">fraction</span> <span class="k">else</span> <span class="s2">&quot;red&quot;</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="n">year</span><span class="p">,</span>
                    <span class="n">monthNumbers</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span>
                    <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">fraction</span> <span class="o">-</span> <span class="n">cmp_fraction</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)),</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                <span class="p">)</span>


<span class="c1"># plot the extracted totals into a given axes</span>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_totals</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">extracted</span><span class="p">,</span> <span class="n">jcsv</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">10.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

    <span class="k">for</span> <span class="n">year_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">exv</span> <span class="o">=</span> <span class="n">format_value</span><span class="p">(</span><span class="n">extracted</span><span class="p">,</span> <span class="s2">&quot;Totals&quot;</span><span class="p">,</span> <span class="n">year_idx</span><span class="p">)</span>
        <span class="n">rrv</span> <span class="o">=</span> <span class="n">format_value</span><span class="p">(</span><span class="n">jcsv</span><span class="p">,</span> <span class="s2">&quot;Totals&quot;</span><span class="p">,</span> <span class="n">year_idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exv</span> <span class="o">==</span> <span class="n">rrv</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">year_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="mf">0.7</span><span class="p">,</span>
                <span class="n">exv</span><span class="p">,</span>
                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">year_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="mf">0.7</span><span class="p">,</span>
                <span class="n">exv</span><span class="p">,</span>
                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">year_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="mf">0.3</span><span class="p">,</span>
                <span class="n">rrv</span><span class="p">,</span>
                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
            <span class="p">)</span>


<span class="c1"># Mark where multi models agreed - for totals</span>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_totals_agreement</span><span class="p">(</span>
    <span class="n">ax</span><span class="p">,</span>
    <span class="n">extracted</span><span class="p">,</span>
    <span class="n">jcsv</span><span class="p">,</span>
    <span class="n">agreement_count</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">10.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

    <span class="k">for</span> <span class="n">year_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
        <span class="n">match</span><span class="p">,</span> <span class="n">exv</span> <span class="o">=</span> <span class="n">models_agree</span><span class="p">(</span>
            <span class="n">extracted</span><span class="p">,</span> <span class="s2">&quot;Totals&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">year_idx</span><span class="p">,</span> <span class="n">agreement_count</span><span class="o">=</span><span class="n">agreement_count</span>
        <span class="p">)</span>
        <span class="n">rrv</span> <span class="o">=</span> <span class="n">format_value</span><span class="p">(</span><span class="n">jcsv</span><span class="p">,</span> <span class="s2">&quot;Totals&quot;</span><span class="p">,</span> <span class="n">year_idx</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>  <span class="c1"># Models agree</span>
            <span class="k">if</span> <span class="n">exv</span> <span class="o">==</span> <span class="n">rrv</span><span class="p">:</span>  <span class="c1"># on the right answer</span>
                <span class="n">colour</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Blue</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># on the wrong answer</span>
                <span class="n">colour</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Red</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Models disagree</span>
            <span class="n">colour</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># Grey</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="n">year_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="mf">0.5</span><span class="p">,</span>
            <span class="n">exv</span><span class="p">,</span>
            <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">colour</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_totals_fraction_agreement</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">merged</span><span class="p">,</span> <span class="n">cmp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">years</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">years</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">years</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
        <span class="n">blue</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;Totals&quot;</span><span class="p">][</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;Totals&quot;</span><span class="p">][</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="n">year</span><span class="p">,</span>
            <span class="mf">0.7</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">blue</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">red</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="s2">&quot;Totals&quot;</span><span class="p">][</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="s2">&quot;Totals&quot;</span><span class="p">][</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">red</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">year</span><span class="p">,</span>
                <span class="mf">0.3</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">red</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_totals_fraction</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">merged</span><span class="p">,</span> <span class="n">cmp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">years</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">years</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">years</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
        <span class="n">fraction</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="s2">&quot;Totals&quot;</span><span class="p">][</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="s2">&quot;Totals&quot;</span><span class="p">][</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="n">year</span><span class="p">,</span>
            <span class="mf">0.7</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">fraction</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">cmp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cmp_fraction</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">cmp</span><span class="p">[</span><span class="s2">&quot;Totals&quot;</span><span class="p">][</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmp</span><span class="p">[</span><span class="s2">&quot;Totals&quot;</span><span class="p">][</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span> <span class="k">if</span> <span class="n">cmp_fraction</span> <span class="o">&lt;</span> <span class="n">fraction</span> <span class="k">else</span> <span class="s2">&quot;red&quot;</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">year</span><span class="p">,</span>
                <span class="mf">0.3</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">fraction</span> <span class="o">-</span> <span class="n">cmp_fraction</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)),</span>
                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">make_null_json</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a null JSON object for cases where no data is available.&quot;&quot;&quot;</span>
    <span class="n">all_na</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span> <span class="s2">&quot;Number&quot;</span><span class="p">:</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span> <span class="s2">&quot;Years&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;N/A&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="s2">&quot;January&quot;</span><span class="p">,</span>
        <span class="s2">&quot;February&quot;</span><span class="p">,</span>
        <span class="s2">&quot;March&quot;</span><span class="p">,</span>
        <span class="s2">&quot;April&quot;</span><span class="p">,</span>
        <span class="s2">&quot;May&quot;</span><span class="p">,</span>
        <span class="s2">&quot;June&quot;</span><span class="p">,</span>
        <span class="s2">&quot;July&quot;</span><span class="p">,</span>
        <span class="s2">&quot;August&quot;</span><span class="p">,</span>
        <span class="s2">&quot;September&quot;</span><span class="p">,</span>
        <span class="s2">&quot;October&quot;</span><span class="p">,</span>
        <span class="s2">&quot;November&quot;</span><span class="p">,</span>
        <span class="s2">&quot;December&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">all_na</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;N/A&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span>
    <span class="n">all_na</span><span class="p">[</span><span class="s2">&quot;Totals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;N/A&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span>
    <span class="k">return</span> <span class="n">all_na</span>


<span class="c1"># Models don&#39;t always make good JSON - fix the egregious problems so it parses</span>
<span class="k">def</span><span class="w"> </span><span class="nf">quote_list_items</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
    <span class="c1"># Get the content inside the brackets</span>
    <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
    <span class="n">quoted</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
    <span class="k">return</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">quoted</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">jsonfix</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fix JSON that has numbers like .12 instead of 0.12&quot;&quot;&quot;</span>
    <span class="n">fixed</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?&lt;!\d)\.(\d+)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;0.\1&quot;</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>  <span class="c1"># Fix numbers like .12 -&gt; 0.12</span>
    <span class="n">fixed</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\d+):&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;&quot;\1&quot;:&#39;</span><span class="p">,</span> <span class="n">fixed</span><span class="p">)</span>  <span class="c1"># Fix keys like 2023: -&gt; &quot;2023&quot;:</span>
    <span class="n">fixed</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[([^\[\]]+)\]&quot;</span><span class="p">,</span> <span class="n">quote_list_items</span><span class="p">,</span> <span class="n">fixed</span><span class="p">)</span>  <span class="c1"># Quote list items</span>
    <span class="n">fixed</span> <span class="o">=</span> <span class="n">fixed</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
    <span class="n">fixed</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">fixed</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isprintable</span><span class="p">()</span>
    <span class="p">)</span>  <span class="c1"># Get rid of line breaks and other non-printable characters</span>
    <span class="c1"># Deal with bad terminations</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fixed</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;]}&quot;</span><span class="p">):</span>
        <span class="n">fixed</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">fixed</span><span class="p">[:</span> <span class="n">fixed</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span>
        <span class="p">)</span>  <span class="c1"># Might cut off too much, but if so we&#39;re screwed anyway.</span>
    <span class="c1"># Get rid of any junk after the totals</span>
    <span class="n">last_match</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&quot;Totals&quot;\s*:\s*\[.*?\]&#39;</span><span class="p">,</span> <span class="n">fixed</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">):</span>
        <span class="n">last_match</span> <span class="o">=</span> <span class="n">m</span>
    <span class="n">fixed</span> <span class="o">=</span> <span class="n">fixed</span><span class="p">[:</span> <span class="n">last_match</span><span class="o">.</span><span class="n">end</span><span class="p">()]</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span> <span class="k">if</span> <span class="n">last_match</span> <span class="k">else</span> <span class="n">fixed</span>
    <span class="k">return</span> <span class="n">fixed</span>


<span class="c1"># map JSON jeys like &#39;TOTALS&#39; to &#39;Totals&#39;</span>
<span class="k">def</span><span class="w"> </span><span class="nf">cap_first_key</span><span class="p">(</span><span class="n">k</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">k</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">k</span>


<span class="c1"># Load the extracted data from a model, for a label</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_extracted</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load the extracted data from a model for a given label.&quot;&quot;&quot;</span>
    <span class="n">null_j</span> <span class="o">=</span> <span class="n">make_null_json</span><span class="p">()</span>
    <span class="n">opfile</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PDIR&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">/extracted/</span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">.json&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">opfile</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No extraction for </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">null_j</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">opfile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">raw_j</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">fixed_j</span> <span class="o">=</span> <span class="n">jsonfix</span><span class="p">(</span><span class="n">raw_j</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">extracted</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">fixed_j</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error decoding JSON for </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">null_j</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">null_j</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extracted</span><span class="p">:</span>
            <span class="n">extracted</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">null_j</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extracted</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">extracted</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="c1"># Ensure lists have 10 items</span>
            <span class="n">extracted</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;N/A&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">extracted</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
    <span class="c1"># Fix boring common error</span>
    <span class="k">if</span> <span class="n">extracted</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;rainfall at&quot;</span><span class="p">):</span>
        <span class="n">extracted</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extracted</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">][</span><span class="mi">12</span><span class="p">:]</span>
    <span class="n">extracted</span> <span class="o">=</span> <span class="p">{</span><span class="n">cap_first_key</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">extracted</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">return</span> <span class="n">extracted</span>


<span class="c1"># find where the model is accurate for each value in one case</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_case</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>

    <span class="c1"># load the image/data pair</span>
    <span class="n">img</span><span class="p">,</span> <span class="n">csv</span> <span class="o">=</span> <span class="n">load_pair</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="n">jcsv</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">csv_to_json</span><span class="p">(</span><span class="n">csv</span><span class="p">))</span>

    <span class="c1"># Load the model extracted data</span>
    <span class="n">extracted</span> <span class="o">=</span> <span class="n">load_extracted</span><span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>

    <span class="c1"># Check if the extracted data matches the CSV data</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">correct</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jcsv</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">extracted</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">correct</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">correct</span><span class="p">[</span><span class="s2">&quot;Number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jcsv</span><span class="p">[</span><span class="s2">&quot;Number&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">extracted</span><span class="p">[</span><span class="s2">&quot;Number&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">correct</span><span class="p">[</span><span class="s2">&quot;Number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">correct</span><span class="p">[</span><span class="s2">&quot;Years&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span>
    <span class="n">correct</span><span class="p">[</span><span class="s2">&quot;Totals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span>
    <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="s2">&quot;January&quot;</span><span class="p">,</span>
        <span class="s2">&quot;February&quot;</span><span class="p">,</span>
        <span class="s2">&quot;March&quot;</span><span class="p">,</span>
        <span class="s2">&quot;April&quot;</span><span class="p">,</span>
        <span class="s2">&quot;May&quot;</span><span class="p">,</span>
        <span class="s2">&quot;June&quot;</span><span class="p">,</span>
        <span class="s2">&quot;July&quot;</span><span class="p">,</span>
        <span class="s2">&quot;August&quot;</span><span class="p">,</span>
        <span class="s2">&quot;September&quot;</span><span class="p">,</span>
        <span class="s2">&quot;October&quot;</span><span class="p">,</span>
        <span class="s2">&quot;November&quot;</span><span class="p">,</span>
        <span class="s2">&quot;December&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">correct</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span>
    <span class="k">for</span> <span class="n">yr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">correct</span><span class="p">[</span><span class="s2">&quot;Years&quot;</span><span class="p">][</span><span class="n">yr</span><span class="p">]</span> <span class="o">=</span> <span class="n">jcsv</span><span class="p">[</span><span class="s2">&quot;Years&quot;</span><span class="p">][</span><span class="n">yr</span><span class="p">]</span> <span class="o">==</span> <span class="n">extracted</span><span class="p">[</span><span class="s2">&quot;Years&quot;</span><span class="p">][</span><span class="n">yr</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
            <span class="n">correct</span><span class="p">[</span><span class="s2">&quot;Years&quot;</span><span class="p">][</span><span class="n">yr</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">correct</span><span class="p">[</span><span class="s2">&quot;Totals&quot;</span><span class="p">][</span><span class="n">yr</span><span class="p">]</span> <span class="o">=</span> <span class="n">jcsv</span><span class="p">[</span><span class="s2">&quot;Totals&quot;</span><span class="p">][</span><span class="n">yr</span><span class="p">]</span> <span class="o">==</span> <span class="n">extracted</span><span class="p">[</span><span class="s2">&quot;Totals&quot;</span><span class="p">][</span><span class="n">yr</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
            <span class="n">correct</span><span class="p">[</span><span class="s2">&quot;Totals&quot;</span><span class="p">][</span><span class="n">yr</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;January&quot;</span><span class="p">,</span>
            <span class="s2">&quot;February&quot;</span><span class="p">,</span>
            <span class="s2">&quot;March&quot;</span><span class="p">,</span>
            <span class="s2">&quot;April&quot;</span><span class="p">,</span>
            <span class="s2">&quot;May&quot;</span><span class="p">,</span>
            <span class="s2">&quot;June&quot;</span><span class="p">,</span>
            <span class="s2">&quot;July&quot;</span><span class="p">,</span>
            <span class="s2">&quot;August&quot;</span><span class="p">,</span>
            <span class="s2">&quot;September&quot;</span><span class="p">,</span>
            <span class="s2">&quot;October&quot;</span><span class="p">,</span>
            <span class="s2">&quot;November&quot;</span><span class="p">,</span>
            <span class="s2">&quot;December&quot;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">correct</span><span class="p">[</span><span class="n">month</span><span class="p">][</span><span class="n">yr</span><span class="p">]</span> <span class="o">=</span> <span class="n">jcsv</span><span class="p">[</span><span class="n">month</span><span class="p">][</span><span class="n">yr</span><span class="p">]</span> <span class="o">==</span> <span class="n">extracted</span><span class="p">[</span><span class="n">month</span><span class="p">][</span><span class="n">yr</span><span class="p">]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                <span class="n">correct</span><span class="p">[</span><span class="n">month</span><span class="p">][</span><span class="n">yr</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">correct</span>


<span class="c1"># Merge validated cases into a single dictionary</span>
<span class="k">def</span><span class="w"> </span><span class="nf">merge_validated_cases</span><span class="p">(</span><span class="n">merged</span><span class="p">,</span> <span class="n">case</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">merged</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="n">case</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">merged</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="n">key</span><span class="p">])):</span>
                    <span class="n">merged</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">case</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">case</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">case</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">case</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">case</span><span class="p">[</span><span class="n">key</span><span class="p">])):</span>
                    <span class="n">merged</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">case</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">merged</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">case</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">merged</span>
</pre></div>
</div>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/RRR_logo.png" alt="Logo of Robot Rainfall Rescue"/>
            </a></p>
<h3><a href="../index.html">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="get_data.html">Download the Rainfall Rescue data</a></li>
<li class="toctree-l1"><a class="reference internal" href="diagnostics.html">Diagnostic plots for Rainfall_Rescue data</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Utility functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../RR_utils/image.html">Image utilities</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../RR_utils/hf.html">Huggingface interface functions</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../models/smolvlm/extract.html">Code to use SmolVLM to extract data from a single image</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/smolvlm/prompts.html">Prompts used to control the extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/gemma/plot_image%2Bextracted.html">Code to plot the results</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../models/smolvlm/extract_multi.html">Code to run SmolVLM on a set of images</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/gemma/plot_stats.html">Plot percentage success rate</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../models/gemma/gemma.html">Code to repeat the analysis with Google Gemma-3-4b</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/granite/granite.html">Code to repeat the analysis with IBM Granite</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../models/gemma/plot_agreement.html">Code to plot multi-model results compared with a sample image</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../models/gemma/plot_stats_agreement.html">Code to plot multi-model statistics over a set of images</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../models/smolvlm/train.html">Code to fine-tune SmolVLM</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../models/smolvlm/extract.html">Run the trained model on a single image</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/gemma/plot_image%2Bcomparison.html">Show comparison between two models for a single image</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../models/gemma/train.html">Code to train Gemma</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/granite/train.html">Code to train Granite</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../how_to.html">How to reproduce or extend this work</a></li>
<li class="toctree-l1"><a class="reference internal" href="../credits.html">Authors and acknowledgements</a></li>
</ul>
<h3><a href="https://github.com/philip-brohan/Robot_Rainfall_Rescue">Get the code</a></h3>

<ul>
<li><a href="https://github.com/philip-brohan/Robot_Rainfall_Rescue"
           rel="nofollow">Github repository</a></li>
<li><a href="https://github.com/philip-brohan/Robot_Rainfall_Rescue/archive/master.zip"
           rel="nofollow">Zip file</a></li>
</ul>

<h3>Found a bug, or have a suggestion?</h3>

Please <a href="https://github.com/philip-brohan/Robot_Rainfall_Rescue/issues/new">raise an issue</a><br>or <a href="mailto://philip.brohan@metoffice.gov.uk">contact Philip</a>.
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../RR_utils/image.html" title="Image processing functions for the Rainfall Rescue images"
             >next</a></li>
        <li class="right" >
          <a href="diagnostics.html" title="Diagnostic plots for Rainfall Rescue data"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">RRR</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Utility functions for Rainfall Rescue data</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    </div>
  </body>
</html>